# jenkins_test
Тестовое задание по развертыванию Jenkins в виде контейнера docker.

## Общее описание playbook

Данный playbook предназначен для развертывания сервиса Jenkins на целевом сервере.
Предполагается что docker уже установлен на целевом сервере и сервис docker запущен.

Применить playbook к целевому inventory можно следующей командой:

`$ ansible-playbook -i inventory playbook-deploy-jenkins.yaml`

Для отката изменений необходимо использовать другой playbook:

`$ ansible-playbook -i inventory playbook-remove-jenkins.yaml`

Обратите внимание! При применении `playbook-remove-jenkins.yaml` будут также удалены все созданные тома (docker volumes) 
и загруженный образ (docker image).

## Пример файла inventory

Для применения сценария `playbook-deploy-jenkins.yaml` необходимо заранее подготовить файл `inventory`.
Можно указать адрес либо hostname целевого сервера в соответствующей группе `docker_host` вместо `IP_ADDRESS`.
Предполагается что развертывание выполняется из под учетной записи root (хотя это и не best practice).
Необходимо задать значения переменных `ansible_user` и `ansible_password`. Или использовать ключи `-u root -k`
для команды `andible-playbook`.

```
[docker_host]
IP_ADDRESS ansible_user=root ansible_password=<root_pass>
```

## Initial Jenkins Password

При первом применении сценария будет создан секрет для первичного логина через web-ui.
Секрет будет указан в соответствующем сообщении, при успешном выполнении сценария.

```
{
    "msg": "Jenkins initial admin password is 87f51a6be3164a17a2c0b4c83cafa482"
}
```

При последующих применениях сценария развертывания первичный секрет более не требуется, т.к. вся конфигурация будет храниться
в соответствующем томе (docker volume) на целевом сервере.

Для переинициализации всей конфигурации сервиса необходимо откатить изменения при помощи сценария отката изменений
и затем повторно выполнить сценарий развертывания.

## Опциональные агрументы

В сценарии можно изменить поведение ansible при развертывании.

* restart: no
При значении `no` параметра restart, контейнер не будет перезапускаться при повторном применении сценария развертывания.
Можно изменить на `yes`, чтобы перезапускался.

* recreate: no
При значении `no` параметра recreate, контейнер не будет пересоздан из образа при повторном применении сценария развертывания.
Можно изменить на `yes`, чтобы пересоздавался.

* Proxy
```
proxy_env:
    http_proxy: http://<proxy_host>:8888
    https_proxy: https://<proxy_host>:8888
```
В случае если целевой сервер имеет доступ в интернет через proxy, следует указать значения соответствующих переменных в
сценарии развертывания `playbook-deploy-jenkins-proxy.yaml` в блоке `vars` и использовать этот сценарий для развертывания.

## Первое подключение

После успешного выполнения сценария развертывания, необходимо подключиться к web-ui, он будет расположен по адресу:

```
http://IP_ADDRESS:8080
```
Где `IP_ADDRESS` - это адрес целевого сервера.

При первом подключении будет запрошен секрет из `/var/jenkins_home/secrets/initialAdminPassword`.
Как его получить смотри  выше в разделе Initial Jenkins Password.
